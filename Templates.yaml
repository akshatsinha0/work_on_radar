# POCM Templates Service API
# 
# This service manages communication templates for our e-commerce platform.
# Templates power transactional emails, SMS notifications, push messages, 
# and in-app content across the customer journey.
#
# INTEGRATION OPTIONS FOR TEMPLATE DELIVERY:
#
# Transactional Email Services:
# - MSG91: Premium deliverability with detailed analytics, great for order confirmations
# - Netcore Cloud: Most cost-effective at scale, requires custom bounce handling
# - Pepipost: Strong template editor and A/B testing features
# - Kaleyra: Excellent API design with powerful routing rules
# - Mailtrap: Perfect for testing email templates before production
#
# Multi-channel Marketing Automation:
# - Omnisend: Built for e-commerce with cart abandonment flows and SMS integration
# - Klaviyo: Segmentation and personalization for product recommendations  
# - Brevo: Good balance of features and pricing with WhatsApp support
# All three offer visual template builders and direct Shopify/WooCommerce connectors
#
# SMS and Messaging APIs:
# - MSG91: Assured standard with strong Indian market presence and compliance tools
# - Kaleyra: Strong in Indian markets with omnichannel capabilities
# - TextLocal: Competitive pricing for high-volume SMS with excellent Indian coverage
# - WhatsApp Business API: Essential for customer support templates
#
# Push and In-App Messaging:
# - MoEngage: Excellent template library with behavioral triggers
# - Blueshift: Visual in-app message builder with real-time personalization
# - Firebase Cloud Messaging: Free option for basic push notifications
#
# Self-Hosted Solutions:
# - Notifo: Open source notification server with MJML email templates
# - Postal: Self-hosted email server for complete control over delivery
# - ntfy: Simple push notification server for internal alerts
#
# RECOMMENDED INTEGRATION PATTERNS:
#
# For Order Lifecycle:
# 1. Order placed → render email template → send via MSG91 for reliability
# 2. Payment confirmed → render SMS template → send via Kaleyra for speed
# 3. Item shipped → render push notification → send via MoEngage with tracking link
#
# For Marketing Campaigns:
# 1. Cart abandoned → trigger Omnisend flow with personalized product images
# 2. Browse abandonment → render email with viewed products via Klaviyo
# 3. Win-back campaigns → multi-channel sequence via Brevo automation
#
# For Customer Support:
# 1. Ticket created → render WhatsApp template via MessageBird API
# 2. Issue resolved → render satisfaction survey via in-app message
# 3. Refund processed → render confirmation email with next steps
#
# TEMPLATE RENDERING APPROACH:
# - Use Liquid templating for dynamic content (Shopify compatible)
# - MJML for responsive email layouts that work across all clients
# - Handlebars for SMS and push templates with fallback text
# - React components for in-app templates with live preview

openapi: 3.0.3
info:
  title: POCM Omnichannel Communication Platform via different possible template formation
  version: 2.2.0
  description: |
    Communication orchestration platform serving daily messages
    across email, SMS, WhatsApp, push notifications, and in-app channels.
    Powers patient care communications, healthcare provider notifications,
    regulatory compliance messaging, and marketing automation.
    
    *Message Volume*: Good amt of messages monthly with valuable delivery success rate
    *Template Library*: Types of imported or pre-built templates for medical device communications (our lab products)
    *Compliance*: HIPAA-compliant messaging, FDA-approved patient communications
    *Personalization*: AI-driven content optimization with 40% engagement improvement
    *Multi-language*: As many Indian languages plus English with medical terminology support
    *Real-time*: Sub-second template rendering with global CDN distribution
    
    *Specialized Features*:
    - Medical device (like those injection patches) usage instructions with interactive media
    - Adverse event reporting workflows with automated escalation
    - Patient adherence reminders with behavioral triggers
    - Healthcare provider alerts with clinical decision support
    - Regulatory compliance notifications with audit trails
    
    *Integration Ecosystem*: Native connectors for EMR systems, pharmacy networks,
    insurance providers, and telemedicine platforms across India (<- if we went with the dreamworks and ideal workflow)
  contact:
    name: POCM Communication Engineering
    email: communications-platform@example.com
  license:
    name: Proprietary
    url: https://our_website_link.com/communication-platform-license

servers:
  - url: https://communications.our_future_website_link.com/v2
    description: Primary communication platform (Mumbai)
  - url: https://communications-blr.our_future_website_link.com/v2
    description: Secondary cluster (Bangalore)
  - url: https://communications-staging.our_future_website_link.com/v2
    description: Staging environment
  - url: https://communications-dev.our_future_website_link.com/v2
    description: Development environment

security:
  - bearerAuth: []
  - apiKeyAuth: []
  - hipaaAuth: []

tags:
  - name: Templates
    description: Template CRUD operations
  - name: Rendering
    description: Template rendering and preview
  - name: Delivery
    description: Template delivery and tracking
  - name: Analytics
    description: Template performance metrics
  - name: Health
    description: Service health checks

paths:
  /templates:
    get:
      tags: [Templates]
      summary: List templates with filtering
      description: |
        Retrieve templates with filtering options.
        Supports pagination, search, and multi-criteria filtering.
      parameters:
        - name: type
          in: query
          description: Filter by template type
          schema:
            type: array
            items:
              $ref: '#/components/schemas/TemplateType'
          style: form
          explode: false
        - name: category
          in: query
          description: Filter by business category
          schema:
            type: array
            items:
              $ref: '#/components/schemas/TemplateCategory'
          style: form
          explode: false
        - name: language
          in: query
          description: Filter by language code
          schema:
            type: string
            pattern: '^[a-z]{2}(-[A-Z]{2})?$'
            example: "en-IN"
        - name: status
          in: query
          description: Filter by template status
          schema:
            type: string
            enum: [draft, active, archived, testing]
            default: active
        - name: search
          in: query
          description: Search in template name and content
          schema:
            type: string
            maxLength: 100
        - name: tags
          in: query
          description: Filter by tags
          schema:
            type: array
            items:
              type: string
          style: form
          explode: false
        - name: limit
          in: query
          description: Number of templates to return
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - name: offset
          in: query
          description: Number of templates to skip
          schema:
            type: integer
            minimum: 0
            default: 0
        - name: sort
          in: query
          description: Sort order
          schema:
            type: string
            enum: [name_asc, name_desc, created_desc, updated_desc, usage_desc]
            default: updated_desc
      responses:
        '200':
          description: Templates retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TemplateListResponse'
        '400':
          description: Invalid query parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    post:
      tags: [Templates]
      summary: Create new template
      description: |
        Create a new template with validation and optional preview generation.
        Supports MJML for emails, Liquid for dynamic content, and Handlebars for SMS.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateTemplateRequest'
            examples:
              email_template:
                summary: Order Confirmation Email
                value:
                  name: "Order Confirmation - Premium"
                  type: "email"
                  category: "transactional"
                  language: "en-IN"
                  subject: "Your POCM order {{order_id}} is confirmed!"
                  content: |
                    <mjml>
                      <mj-body>
                        <mj-section>
                          <mj-column>
                            <mj-text>
                              <h2>Thank you {{customer_name}}!</h2>
                              <p>Your order {{order_id}} for ₹{{total_amount}} has been confirmed.</p>
                              <p>Estimated delivery: {{delivery_date}}</p>
                            </mj-text>
                          </mj-column>
                        </mj-section>
                      </mj-body>
                    </mjml>
                  variables:
                    - name: "customer_name"
                      type: "string"
                      required: true
                      description: "Customer's full name"
                    - name: "order_id"
                      type: "string"
                      required: true
                      description: "Order identifier"
                    - name: "total_amount"
                      type: "number"
                      required: true
                      description: "Order total in INR"
                  tags: ["order", "confirmation", "transactional"]
              sms_template:
                summary: Delivery Update SMS
                value:
                  name: "Delivery Update - Out for Delivery"
                  type: "sms"
                  category: "logistics"
                  language: "en-IN"
                  content: "Hi {{customer_name}}, your POCM order {{order_id}} is out for delivery! Track: {{tracking_url}}"
                  variables:
                    - name: "customer_name"
                      type: "string"
                      required: true
                    - name: "order_id"
                      type: "string"
                      required: true
                    - name: "tracking_url"
                      type: "string"
                      required: true
                  tags: ["delivery", "logistics", "tracking"]
      responses:
        '201':
          description: Template created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Template'
        '400':
          description: Invalid template data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Template name already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /templates/{id}:
    get:
      tags: [Templates]
      summary: Get template by ID
      parameters:
        - name: id
          in: path
          required: true
          description: Template identifier
          schema:
            type: string
            pattern: '^[a-zA-Z0-9_-]+$'
      responses:
        '200':
          description: Template found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Template'
        '404':
          description: Template not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    put:
      tags: [Templates]
      summary: Update template
      parameters:
        - name: id
          in: path
          required: true
          description: Template identifier
          schema:
            type: string
            pattern: '^[a-zA-Z0-9_-]+$'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateTemplateRequest'
      responses:
        '200':
          description: Template updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Template'
        '404':
          description: Template not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Template name conflict
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    delete:
      tags: [Templates]
      summary: Delete template
      description: |
        Soft delete a template. Templates used in active campaigns cannot be deleted.
        Use archive status instead for templates that should not be used for new campaigns.
      parameters:
        - name: id
          in: path
          required: true
          description: Template identifier
          schema:
            type: string
            pattern: '^[a-zA-Z0-9_-]+$'
        - name: force
          in: query
          description: Force delete even if template is in use
          schema:
            type: boolean
            default: false
      responses:
        '204':
          description: Template deleted successfully
        '404':
          description: Template not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Template is in use and cannot be deleted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /templates/{id}/render:
    post:
      tags: [Rendering]
      summary: Render template with data
      description: |
        Render a template with provided variables and return the final content.
        Supports preview mode for testing without sending actual messages.
      parameters:
        - name: id
          in: path
          required: true
          description: Template identifier
          schema:
            type: string
            pattern: '^[a-zA-Z0-9_-]+$'
        - name: preview
          in: query
          description: Enable preview mode with sample data
          schema:
            type: boolean
            default: false
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RenderRequest'
            examples:
              order_confirmation:
                summary: Order Confirmation Data
                value:
                  variables:
                    patient_name: "Dr. Priya Sharma"
                    order_id: "POCM-2025-001234"
                    total_amount: 12495.00
                    delivery_date: "2025-08-15"
                    items:
                      - name: "Nanofluidic Insulin Patch - Continuous Glucose Management"
                        quantity: 10
                        price: 1249.50
                        batch_number: "BATCH_20250810_MUM"
                        expiry_date: "2025-11-15"
                        regulatory_approval: "FDA_510K_APPROVED"
                    healthcare_provider:
                      name: "Apollo Hospital Mumbai"
                      license_number: "MH_MED_12345"
                      specialization: "Endocrinology"
                    patient_safety_info:
                      allergies: ["latex", "adhesive_sensitivity"]
                      contraindications: []
                      emergency_contact: "+91-98765-43210"
                  personalization:
                    user_id: "user_12345"
                    segment: "premium_customer"
                    location: "Mumbai"
                  options:
                    format: "html"
                    include_tracking: true
      responses:
        '200':
          description: Template rendered successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RenderResponse'
              examples:
                rendered_email:
                  value:
                    rendered_content: |
                      <html>
                        <body>
                          <h2>Thank you Rajesh Kumar!</h2>
                          <p>Your order POCM-2025-001234 for ₹2499.00 has been confirmed.</p>
                          <p>Estimated delivery: 2025-08-15</p>
                        </body>
                      </html>
                    rendered_subject: "Your POCM order POCM-2025-001234 is confirmed!"
                    metadata:
                      render_time_ms: 45
                      template_version: "v1.2"
                      variables_used: ["customer_name", "order_id", "total_amount"]
        '400':
          description: Invalid render request or missing variables
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Template not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /templates/medical/device-instructions:
    post:
      tags: [Medical]
      summary: Generate device instruction templates
      description: |
        Specialized endpoint for generating medical device instruction templates
        with interactive media, safety warnings, and compliance requirements.
        Automatically includes regulatory disclaimers and emergency contact information.
        
        *Features*: Multi-language support, accessibility compliance, video integration
        *Compliance*: FDA-approved content, HIPAA-compliant delivery
        *Personalization*: Device-specific instructions, patient medical history integration
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [device_type, patient_profile, instruction_type]
              properties:
                device_type:
                  type: string
                  enum: [insulin_patch, pain_relief_patch, hormone_patch, diagnostic_sensor]
                  example: "insulin_patch"
                patient_profile:
                  type: object
                  properties:
                    age_group:
                      type: string
                      enum: [pediatric, adult, geriatric]
                    medical_conditions:
                      type: array
                      items:
                        type: string
                    language_preference:
                      type: string
                      example: "hi-IN"
                    literacy_level:
                      type: string
                      enum: [basic, intermediate, advanced]
                    visual_impairment:
                      type: boolean
                instruction_type:
                  type: string
                  enum: [first_use, daily_use, troubleshooting, emergency, disposal]
                  example: "first_use"
                delivery_channels:
                  type: array
                  items:
                    type: string
                    enum: [email, sms, whatsapp, app_notification, printed_guide]
                include_media:
                  type: boolean
                  default: true
                  description: Include instructional videos and images
      responses:
        '200':
          description: Device instructions generated
          content:
            application/json:
              schema:
                type: object
                properties:
                  instruction_id:
                    type: string
                  templates_generated:
                    type: array
                    items:
                      type: object
                      properties:
                        channel:
                          type: string
                        template_id:
                          type: string
                        content_preview:
                          type: string
                        media_assets:
                          type: array
                          items:
                            type: string
                  compliance_verification:
                    type: object
                    properties:
                      fda_approved:
                        type: boolean
                      hipaa_compliant:
                        type: boolean
                      accessibility_score:
                        type: number

  /templates/medical/adverse-event-workflow:
    post:
      tags: [Medical]
      summary: Trigger adverse event communication workflow
      description: |
        Automated communication workflow for adverse event reporting and management.
        Handles patient notifications, healthcare provider alerts, regulatory reporting,
        and follow-up care coordination with appropriate escalation protocols.
        
        *Workflow Steps*: Initial assessment → Provider notification → Patient follow-up → Regulatory filing
        *Compliance*: Automatic FDA MedWatch integration, HIPAA-compliant communications
        *Escalation*: Severity-based routing with emergency protocol activation
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [device_id, event_severity, patient_id, reporter_type]
              properties:
                device_id:
                  type: string
                  example: "NFLX_A1B2C3D4"
                event_severity:
                  type: string
                  enum: [mild, moderate, severe, life_threatening]
                patient_id:
                  type: string
                  example: "PT_HASH_ABC123"
                reporter_type:
                  type: string
                  enum: [patient, healthcare_provider, caregiver]
                event_description:
                  type: string
                  maxLength: 2000
                healthcare_provider_id:
                  type: string
                  nullable: true
                immediate_medical_attention:
                  type: boolean
                  default: false
      responses:
        '202':
          description: Adverse event workflow initiated
          content:
            application/json:
              schema:
                type: object
                properties:
                  workflow_id:
                    type: string
                  case_number:
                    type: string
                  notifications_sent:
                    type: array
                    items:
                      type: object
                      properties:
                        recipient_type:
                          type: string
                        channel:
                          type: string
                        message_id:
                          type: string
                        priority:
                          type: string
                  regulatory_filing_required:
                    type: boolean
                  estimated_resolution_time:
                    type: string
                    format: date-time

  /templates/bulk/healthcare-providers:
    post:
      tags: [Bulk]
      summary: Bulk communication to healthcare providers
      description: |
        Bulk messaging for healthcare provider networks.
        Supports segmented messaging based on specialization, location, patient volume,
        and device usage patterns with compliance tracking and delivery confirmation.
        
        *Scale*: Up to 100 providers per batch
        *Segmentation*: Specialty, geography, patient demographics, device usage
        *Compliance*: Medical communication regulations, opt-out management
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [template_id, provider_segments, message_priority]
              properties:
                template_id:
                  type: string
                provider_segments:
                  type: array
                  items:
                    type: object
                    properties:
                      segment_name:
                        type: string
                      criteria:
                        type: object
                        properties:
                          specialties:
                            type: array
                            items:
                              type: string
                          regions:
                            type: array
                            items:
                              type: string
                          patient_volume:
                            type: object
                            properties:
                              min:
                                type: integer
                              max:
                                type: integer
                message_priority:
                  type: string
                  enum: [routine, urgent, emergency, regulatory_required]
                delivery_schedule:
                  type: object
                  properties:
                    immediate:
                      type: boolean
                    scheduled_time:
                      type: string
                      format: date-time
                    timezone:
                      type: string
                compliance_requirements:
                  type: object
                  properties:
                    delivery_confirmation:
                      type: boolean
                    read_receipt:
                      type: boolean
                    response_tracking:
                      type: boolean
      responses:
        '202':
          description: Bulk communication initiated
          content:
            application/json:
              schema:
                type: object
                properties:
                  bulk_id:
                    type: string
                    example: "bulk_2025_08_10_001"
                  status:
                    type: string
                    enum: [accepted, processing]
                    example: "accepted"
                  total_recipients:
                    type: integer
                    example: 1250
                  estimated_completion:
                    type: string
                    format: date-time
                    example: "2025-08-10T19:30:00Z"
                  tracking_url:
                    type: string
                    format: uri
                    example: "https://communications.our_future_website_link.com/v2/bulk/bulk_2025_08_10_001/status"
        '400':
          description: Invalid bulk request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '429':
          description: Rate limit exceeded for bulk operations
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /templates/{id}/send:
    post:
      tags: [Delivery]
      summary: Intelligent message delivery
      description: |
        Message delivery with AI-powered optimization, compliance validation,
        and multi-channel failover. Automatically selects optimal delivery time and channel
        based on recipient behavior patterns and message urgency.
      parameters:
        - name: id
          in: path
          required: true
          description: Template identifier
          schema:
            type: string
            pattern: '^[a-zA-Z0-9_-]+$'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SendRequest'
            examples:
              send_email:
                summary: Send Order Confirmation Email
                value:
                  recipient:
                    email: "rajesh.kumar@example.com"
                    name: "Rajesh Kumar"
                    user_id: "user_12345"
                  variables:
                    customer_name: "Rajesh Kumar"
                    order_id: "POCM-2025-001234"
                    total_amount: 2499.00
                    delivery_date: "2025-08-15"
                  delivery_options:
                    provider: "msg91"
                    priority: "high"
                    track_opens: true
                    track_clicks: true
                  metadata:
                    campaign_id: "order_confirmation_v2"
                    source: "checkout_service"
              send_sms:
                summary: Send Delivery Update SMS
                value:
                  recipient:
                    phone: "+919876543210"
                    name: "Rajesh Kumar"
                    user_id: "user_12345"
                  variables:
                    customer_name: "Rajesh"
                    order_id: "POCM-2025-001234"
                    tracking_url: "https://track.our_website_link.com/POCM-2025-001234"
                  delivery_options:
                    provider: "kaleyra"
                    priority: "normal"
      responses:
        '202':
          description: Message queued for delivery
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SendResponse'
        '400':
          description: Invalid send request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Template not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /templates/{id}/variants:
    get:
      tags: [Templates]
      summary: Get template variants for A/B testing
      parameters:
        - name: id
          in: path
          required: true
          description: Template identifier
          schema:
            type: string
            pattern: '^[a-zA-Z0-9_-]+$'
      responses:
        '200':
          description: Template variants retrieved
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/TemplateVariant'

    post:
      tags: [Templates]
      summary: Create template variant
      parameters:
        - name: id
          in: path
          required: true
          description: Template identifier
          schema:
            type: string
            pattern: '^[a-zA-Z0-9_-]+$'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateVariantRequest'
      responses:
        '201':
          description: Variant created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TemplateVariant'

  /templates/analytics:
    get:
      tags: [Analytics]
      summary: Get template performance analytics
      description: |
        Retrieve performance metrics for templates including delivery rates,
        open rates, click rates, and conversion tracking.
      parameters:
        - name: template_ids
          in: query
          description: Filter by specific template IDs
          schema:
            type: array
            items:
              type: string
          style: form
          explode: false
        - name: date_from
          in: query
          description: Start date for analytics period
          schema:
            type: string
            format: date
            example: "2025-08-01"
        - name: date_to
          in: query
          description: End date for analytics period
          schema:
            type: string
            format: date
            example: "2025-08-10"
        - name: group_by
          in: query
          description: Group results by dimension
          schema:
            type: string
            enum: [template, category, type, day, week, month]
            default: template
      responses:
        '200':
          description: Analytics data retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AnalyticsResponse'

  /delivery/status/{message_id}:
    get:
      tags: [Delivery]
      summary: Get message delivery status
      parameters:
        - name: message_id
          in: path
          required: true
          description: Message identifier from send response
          schema:
            type: string
      responses:
        '200':
          description: Delivery status retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeliveryStatus'

  /health:
    get:
      tags: [Health]
      summary: Health check
      description: Basic health check for load balancers
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "healthy"
                  timestamp:
                    type: string
                    format: date-time
                  version:
                    type: string
                    example: "2.0.0"

  /ready:
    get:
      tags: [Health]
      summary: Readiness check
      description: Readiness check for Kubernetes probes
      responses:
        '200':
          description: Service is ready
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "ready"
                  dependencies:
                    type: object
                    properties:
                      database:
                        type: string
                        example: "connected"
                      template_engine:
                        type: string
                        example: "ready"
                      delivery_providers:
                        type: object
                        properties:
                          msg91:
                            type: string
                            example: "connected"
                          kaleyra:
                            type: string
                            example: "connected"

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token for service authentication
    apiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: API key for service-to-service communication
    hipaaAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        HIPAA-compliant authentication for medical communications.
        Includes additional claims for healthcare provider verification,
        patient consent validation, and audit trail requirements.

  schemas:
    TemplateType:
      type: string
      enum: [
        # Standard Communication Channels
        email, sms, push, whatsapp, in_app, webhook,
        # Medical Device Specific Channels
        device_display, voice_alert, haptic_feedback, led_indicator,
        # Healthcare Provider Channels
        emr_integration, pager_alert, clinical_dashboard, fax,
        # Compliance & Documentation Channels
        regulatory_filing, audit_report, printed_material, video_instruction,
        # Emergency & Critical Channels
        emergency_broadcast, critical_alert, escalation_chain
      ]
      description: |
        Comprehensive communication channels for healthcare ecosystem:
        
        *Standard Channels*:
        - email: HIPAA-compliant HTML/text emails with encryption
        - sms: Secure SMS with patient consent verification
        - whatsapp: WhatsApp Business API with end-to-end encryption
        - push: Mobile app notifications with medical alert priorities
        
        *Medical Device Integration*:
        - device_display: Direct messages to device LCD/OLED screens
        - voice_alert: Audio notifications for critical device states
        - haptic_feedback: Vibration patterns for patient alerts
        - led_indicator: Color-coded LED status communications
        
        *Healthcare Provider Systems*:
        - emr_integration: Direct integration with Electronic Medical Records
        - clinical_dashboard: Real-time provider dashboard notifications
        - pager_alert: Legacy pager system integration for hospitals
        
        *Compliance & Documentation*:
        - regulatory_filing: Automated FDA/regulatory body submissions
        - audit_report: Compliance documentation and audit trails
        - printed_material: Patient information leaflets and instructions
        - video_instruction: Interactive video content for device training
        
        *Emergency Protocols*:
        - emergency_broadcast: Multi-channel emergency notifications
        - critical_alert: High-priority medical alerts with escalation
        - escalation_chain: Automated escalation to medical professionals

    TemplateCategory:
      type: string
      enum: [
        # Core Business Categories
        transactional, marketing, support, system, lifecycle, promotional,
        # Medical Device Specific Categories
        patient_care, device_instructions, adverse_events, clinical_alerts,
        # Healthcare Provider Categories  
        provider_notifications, training_materials, compliance_reports,
        # Regulatory & Compliance Categories
        regulatory_filing, safety_alerts, recall_notifications, audit_communications,
        # B2B Healthcare Categories
        bulk_orders, certification_updates, partnership_communications
      ]
      description: |
        Comprehensive template categories for POCM's healthcare ecosystem:
        
        *Core Business*:
        - transactional: Order confirmations, receipts, delivery updates
        - marketing: Product education, clinical studies, health awareness campaigns
        - support: Technical support, clinical guidance, troubleshooting
        - system: Account management, authentication, platform notifications
        
        *Patient Care*:
        - patient_care: Treatment reminders, adherence support, wellness check-ins
        - device_instructions: Usage guides, safety protocols, maintenance alerts
        - adverse_events: Incident reporting, follow-up care, safety monitoring
        - clinical_alerts: Critical readings, emergency protocols, care escalation
        
        *Healthcare Providers*:
        - provider_notifications: Patient updates, device alerts, clinical insights
        - training_materials: Device education, best practices, certification programs
        - compliance_reports: Usage analytics, patient outcomes, regulatory updates
        
        *Regulatory Compliance*:
        - regulatory_filing: FDA submissions, clinical trial communications
        - safety_alerts: Device recalls, safety updates, risk communications
        - audit_communications: Compliance verification, quality assurance updates

    TemplateVariable:
      type: object
      required: [name, type, required]
      properties:
        name:
          type: string
          pattern: '^[a-zA-Z][a-zA-Z0-9_]*$'
          description: Variable name for template substitution
          example: "customer_name"
        type:
          type: string
          enum: [string, number, boolean, date, array, object]
          description: Expected data type for validation
        required:
          type: boolean
          description: Whether this variable must be provided
          example: true
        description:
          type: string
          maxLength: 200
          description: Human-readable description of the variable
          example: "Customer's full name for personalization"
        default_value:
          description: Default value if not provided (for optional variables)
          example: "Valued Customer"
        validation:
          type: object
          description: Additional validation rules
          properties:
            min_length:
              type: integer
              minimum: 0
            max_length:
              type: integer
              minimum: 1
            pattern:
              type: string
              description: Regex pattern for string validation
            min_value:
              type: number
              description: Minimum value for numbers
            max_value:
              type: number
              description: Maximum value for numbers

    Template:
      type: object
      required: [id, name, type, category, content, status, created_at, updated_at]
      properties:
        id:
          type: string
          pattern: '^[a-zA-Z0-9_-]+$'
          description: Unique template identifier
          example: "order_confirmation_premium_v2"
        name:
          type: string
          minLength: 3
          maxLength: 100
          description: Human-readable template name
          example: "Order Confirmation - Premium"
        type:
          $ref: '#/components/schemas/TemplateType'
        category:
          $ref: '#/components/schemas/TemplateCategory'
        language:
          type: string
          pattern: '^[a-z]{2}(-[A-Z]{2})?$'
          description: Language code (ISO 639-1 with optional country)
          example: "en-IN"
        subject:
          type: string
          maxLength: 200
          description: Email subject line or SMS/push title
          example: "Your POCM order {{order_id}} is confirmed!"
        content:
          type: string
          maxLength: 50000
          description: Template content with variable placeholders
          example: |
            <mjml>
              <mj-body>
                <mj-section>
                  <mj-column>
                    <mj-text>
                      <h2>Thank you {{customer_name}}!</h2>
                      <p>Your order {{order_id}} for ₹{{total_amount}} has been confirmed.</p>
                    </mj-text>
                  </mj-column>
                </mj-section>
              </mj-body>
            </mjml>
        variables:
          type: array
          items:
            $ref: '#/components/schemas/TemplateVariable'
          description: List of variables used in the template
        tags:
          type: array
          items:
            type: string
            pattern: '^[a-zA-Z0-9_-]+$'
          maxItems: 10
          description: Tags for template organization and search
          example: ["order", "confirmation", "transactional", "premium"]
        status:
          type: string
          enum: [draft, active, archived, testing]
          description: Template lifecycle status
          example: "active"
        version:
          type: string
          pattern: '^v\d+\.\d+$'
          description: Template version for change tracking
          example: "v1.2"
        delivery_config:
          type: object
          description: Channel-specific delivery configuration
          properties:
            provider:
              type: string
              enum: [msg91, netcore, pepipost, kaleyra, textlocal, firebase]
              description: Preferred delivery provider
            priority:
              type: string
              enum: [low, normal, high, urgent]
              default: normal
            retry_policy:
              type: object
              properties:
                max_attempts:
                  type: integer
                  minimum: 1
                  maximum: 5
                  default: 3
                backoff_seconds:
                  type: integer
                  minimum: 1
                  maximum: 3600
                  default: 60
        analytics:
          type: object
          readOnly: true
          description: Template performance metrics
          properties:
            total_sent:
              type: integer
              minimum: 0
              description: Total messages sent using this template
            delivery_rate:
              type: number
              format: double
              minimum: 0
              maximum: 1
              description: Successful delivery rate
            open_rate:
              type: number
              format: double
              minimum: 0
              maximum: 1
              description: Email open rate (email templates only)
            click_rate:
              type: number
              format: double
              minimum: 0
              maximum: 1
              description: Click-through rate
            conversion_rate:
              type: number
              format: double
              minimum: 0
              maximum: 1
              description: Conversion rate to desired action
        created_at:
          type: string
          format: date-time
          readOnly: true
          description: Template creation timestamp
          example: "2025-08-10T10:30:00Z"
        updated_at:
          type: string
          format: date-time
          readOnly: true
          description: Last modification timestamp
          example: "2025-08-10T15:45:00Z"
        created_by:
          type: string
          readOnly: true
          description: User who created the template
          example: "marketing_team"
        updated_by:
          type: string
          readOnly: true
          description: User who last modified the template
          example: "content_manager"

    CreateTemplateRequest:
      type: object
      required: [name, type, category, content]
      properties:
        name:
          type: string
          minLength: 3
          maxLength: 100
          description: Human-readable template name
          example: "Order Confirmation - Premium"
        type:
          $ref: '#/components/schemas/TemplateType'
        category:
          $ref: '#/components/schemas/TemplateCategory'
        language:
          type: string
          pattern: '^[a-z]{2}(-[A-Z]{2})?$'
          default: "en-IN"
          description: Language code
          example: "en-IN"
        subject:
          type: string
          maxLength: 200
          description: Email subject or message title
          example: "Your POCM order {{order_id}} is confirmed!"
        content:
          type: string
          maxLength: 50000
          description: Template content with variable placeholders
        variables:
          type: array
          items:
            $ref: '#/components/schemas/TemplateVariable'
          description: Variables used in the template
        tags:
          type: array
          items:
            type: string
            pattern: '^[a-zA-Z0-9_-]+$'
          maxItems: 10
          description: Tags for organization
          example: ["order", "confirmation", "transactional"]
        delivery_config:
          type: object
          description: Delivery configuration
          properties:
            provider:
              type: string
              enum: [msg91, netcore, pepipost, kaleyra, textlocal, firebase]
            priority:
              type: string
              enum: [low, normal, high, urgent]
              default: normal

    UpdateTemplateRequest:
      type: object
      properties:
        name:
          type: string
          minLength: 3
          maxLength: 100
        subject:
          type: string
          maxLength: 200
        content:
          type: string
          maxLength: 50000
        variables:
          type: array
          items:
            $ref: '#/components/schemas/TemplateVariable'
        tags:
          type: array
          items:
            type: string
            pattern: '^[a-zA-Z0-9_-]+$'
          maxItems: 10
        status:
          type: string
          enum: [draft, active, archived, testing]
        delivery_config:
          type: object
          properties:
            provider:
              type: string
              enum: [msg91, netcore, pepipost, kaleyra, textlocal, firebase]
            priority:
              type: string
              enum: [low, normal, high, urgent]

    TemplateListResponse:
      type: object
      required: [templates, total, limit, offset]
      properties:
        templates:
          type: array
          items:
            $ref: '#/components/schemas/Template'
        total:
          type: integer
          minimum: 0
          description: Total number of templates matching filters
          example: 45
        limit:
          type: integer
          minimum: 1
          description: Number of templates returned
          example: 20
        offset:
          type: integer
          minimum: 0
          description: Number of templates skipped
          example: 0
        has_more:
          type: boolean
          description: Whether more templates are available
          example: true

    RenderRequest:
      type: object
      required: [variables]
      properties:
        variables:
          type: object
          description: Key-value pairs for template variable substitution
          example:
            customer_name: "Rajesh Kumar"
            order_id: "POCM-2025-001234"
            total_amount: 2499.00
        personalization:
          type: object
          description: Additional personalization data
          properties:
            user_id:
              type: string
              description: User identifier for personalized content
            segment:
              type: string
              description: Customer segment for targeted messaging
            location:
              type: string
              description: User location for localized content
            preferences:
              type: object
              description: User preferences for content customization
        options:
          type: object
          description: Rendering options
          properties:
            format:
              type: string
              enum: [html, text, json]
              default: html
              description: Output format for rendered content
            include_tracking:
              type: boolean
              default: true
              description: Include tracking pixels and links
            validate_variables:
              type: boolean
              default: true
              description: Validate all required variables are provided

    RenderResponse:
      type: object
      required: [rendered_content]
      properties:
        rendered_content:
          type: string
          description: Final rendered template content
          example: |
            <html>
              <body>
                <h2>Thank you Rajesh Kumar!</h2>
                <p>Your order POCM-2025-001234 for ₹2499.00 has been confirmed.</p>
              </body>
            </html>
        rendered_subject:
          type: string
          description: Rendered subject line (for email templates)
          example: "Your POCM order POCM-2025-001234 is confirmed!"
        metadata:
          type: object
          description: Rendering metadata
          properties:
            render_time_ms:
              type: integer
              description: Time taken to render template in milliseconds
              example: 45
            template_version:
              type: string
              description: Version of template used for rendering
              example: "v1.2"
            variables_used:
              type: array
              items:
                type: string
              description: List of variables that were substituted
              example: ["customer_name", "order_id", "total_amount"]
            warnings:
              type: array
              items:
                type: string
              description: Non-fatal warnings during rendering
              example: ["Variable 'optional_field' not provided, using default"]

    SendRequest:
      type: object
      required: [recipient, variables]
      properties:
        recipient:
          type: object
          required: [email]
          properties:
            email:
              type: string
              format: email
              description: Recipient email address
              example: "rajesh.kumar@example.com"
            phone:
              type: string
              pattern: '^\+[1-9]\d{1,14}$'
              description: Recipient phone number (E.164 format)
              example: "+919876543210"
            name:
              type: string
              maxLength: 100
              description: Recipient display name
              example: "Rajesh Kumar"
            user_id:
              type: string
              description: Internal user identifier
              example: "user_12345"
        variables:
          type: object
          description: Template variables for rendering
          example:
            customer_name: "Rajesh Kumar"
            order_id: "POCM-2025-001234"
            total_amount: 2499.00
        delivery_options:
          type: object
          description: Delivery-specific options
          properties:
            provider:
              type: string
              enum: [msg91, netcore, pepipost, kaleyra, textlocal, firebase]
              description: Override default delivery provider
            priority:
              type: string
              enum: [low, normal, high, urgent]
              default: normal
              description: Message priority level
            scheduled_at:
              type: string
              format: date-time
              description: Schedule message for future delivery
              example: "2025-08-11T09:00:00Z"
            track_opens:
              type: boolean
              default: true
              description: Enable open tracking (email only)
            track_clicks:
              type: boolean
              default: true
              description: Enable click tracking
            custom_headers:
              type: object
              description: Custom headers for email delivery
              example:
                X-Campaign-ID: "summer_sale_2025"
        metadata:
          type: object
          description: Additional metadata for tracking
          properties:
            campaign_id:
              type: string
              description: Marketing campaign identifier
              example: "order_confirmation_v2"
            source:
              type: string
              description: Source service or system
              example: "checkout_service"
            correlation_id:
              type: string
              description: Request correlation identifier
              example: "req_abc123def456"

    SendResponse:
      type: object
      required: [message_id, status, queued_at]
      properties:
        message_id:
          type: string
          description: Unique message identifier for tracking
          example: "msg_1234567890abcdef"
        status:
          type: string
          enum: [queued, sent, failed]
          description: Initial delivery status
          example: "queued"
        queued_at:
          type: string
          format: date-time
          description: When message was queued for delivery
          example: "2025-08-10T18:45:01Z"
        estimated_delivery:
          type: string
          format: date-time
          description: Estimated delivery time
          example: "2025-08-10T18:45:05Z"
        provider:
          type: string
          description: Delivery provider used
          example: "msg91"
        tracking_url:
          type: string
          format: uri
          description: URL to track message delivery status
          example: "https://templates.our_website_link.com/track/msg_1234567890abcdef"

    TemplateVariant:
      type: object
      required: [id, name, weight, content]
      properties:
        id:
          type: string
          description: Variant identifier
          example: "variant_b"
        name:
          type: string
          description: Variant name for identification
          example: "Higher Urgency Version"
        weight:
          type: integer
          minimum: 1
          maximum: 100
          description: Traffic percentage for A/B testing
          example: 50
        subject:
          type: string
          description: Variant subject line
          example: "URGENT: Complete your POCM order {{order_id}} now!"
        content:
          type: string
          description: Variant template content
        status:
          type: string
          enum: [draft, testing, active, paused]
          description: Variant status
          example: "testing"
        performance:
          type: object
          readOnly: true
          description: A/B test performance metrics
          properties:
            impressions:
              type: integer
              minimum: 0
            conversions:
              type: integer
              minimum: 0
            conversion_rate:
              type: number
              format: double
              minimum: 0
              maximum: 1
            confidence_level:
              type: number
              format: double
              minimum: 0
              maximum: 1
              description: Statistical confidence in results

    CreateVariantRequest:
      type: object
      required: [name, weight, content]
      properties:
        name:
          type: string
          minLength: 3
          maxLength: 100
          description: Variant name
        weight:
          type: integer
          minimum: 1
          maximum: 100
          description: Traffic percentage
        subject:
          type: string
          maxLength: 200
          description: Variant subject line
        content:
          type: string
          maxLength: 50000
          description: Variant content

    DeliveryStatus:
      type: object
      required: [message_id, status, created_at]
      properties:
        message_id:
          type: string
          description: Message identifier
          example: "msg_1234567890abcdef"
        status:
          type: string
          enum: [queued, sent, delivered, opened, clicked, bounced, failed, complained]
          description: Current delivery status
          example: "delivered"
        created_at:
          type: string
          format: date-time
          description: Message creation time
          example: "2025-08-10T18:45:01Z"
        sent_at:
          type: string
          format: date-time
          nullable: true
          description: When message was sent
          example: "2025-08-10T18:45:03Z"
        delivered_at:
          type: string
          format: date-time
          nullable: true
          description: When message was delivered
          example: "2025-08-10T18:45:05Z"
        opened_at:
          type: string
          format: date-time
          nullable: true
          description: When message was first opened
          example: "2025-08-10T19:15:22Z"
        clicked_at:
          type: string
          format: date-time
          nullable: true
          description: When first link was clicked
          example: "2025-08-10T19:16:45Z"
        provider:
          type: string
          description: Delivery provider used
          example: "msg91"
        provider_message_id:
          type: string
          description: Provider-specific message ID
          example: "pm_msg_abc123"
        error_message:
          type: string
          nullable: true
          description: Error message if delivery failed
          example: "Recipient email address does not exist"
        bounce_reason:
          type: string
          nullable: true
          description: Bounce reason if applicable
          example: "mailbox_full"
        events:
          type: array
          items:
            type: object
            properties:
              event:
                type: string
                enum: [queued, sent, delivered, opened, clicked, bounced, failed, complained]
              timestamp:
                type: string
                format: date-time
              details:
                type: object
                description: Event-specific details
          description: Chronological list of delivery events

    AnalyticsResponse:
      type: object
      required: [period, metrics]
      properties:
        period:
          type: object
          required: [from, to]
          properties:
            from:
              type: string
              format: date
              description: Analytics period start date
              example: "2025-08-01"
            to:
              type: string
              format: date
              description: Analytics period end date
              example: "2025-08-10"
        metrics:
          type: array
          items:
            type: object
            required: [template_id, template_name, stats]
            properties:
              template_id:
                type: string
                description: Template identifier
                example: "order_confirmation_premium_v2"
              template_name:
                type: string
                description: Template display name
                example: "Order Confirmation - Premium"
              template_type:
                $ref: '#/components/schemas/TemplateType'
              template_category:
                $ref: '#/components/schemas/TemplateCategory'
              stats:
                type: object
                required: [total_sent, delivery_rate]
                properties:
                  total_sent:
                    type: integer
                    minimum: 0
                    description: Total messages sent
                    example: 1250
                  delivered:
                    type: integer
                    minimum: 0
                    description: Successfully delivered messages
                    example: 1235
                  delivery_rate:
                    type: number
                    format: double
                    minimum: 0
                    maximum: 1
                    description: Delivery success rate
                    example: 0.988
                  opened:
                    type: integer
                    minimum: 0
                    description: Messages opened (email only)
                    example: 892
                  open_rate:
                    type: number
                    format: double
                    minimum: 0
                    maximum: 1
                    description: Open rate (email only)
                    example: 0.722
                  clicked:
                    type: integer
                    minimum: 0
                    description: Messages with clicks
                    example: 234
                  click_rate:
                    type: number
                    format: double
                    minimum: 0
                    maximum: 1
                    description: Click-through rate
                    example: 0.262
                  conversions:
                    type: integer
                    minimum: 0
                    description: Conversions attributed to template
                    example: 89
                  conversion_rate:
                    type: number
                    format: double
                    minimum: 0
                    maximum: 1
                    description: Conversion rate
                    example: 0.071
                  bounced:
                    type: integer
                    minimum: 0
                    description: Bounced messages
                    example: 12
                  bounce_rate:
                    type: number
                    format: double
                    minimum: 0
                    maximum: 1
                    description: Bounce rate
                    example: 0.0096
                  complained:
                    type: integer
                    minimum: 0
                    description: Spam complaints
                    example: 3
                  complaint_rate:
                    type: number
                    format: double
                    minimum: 0
                    maximum: 1
                    description: Complaint rate
                    example: 0.0024
                  revenue_attributed:
                    type: number
                    format: double
                    minimum: 0
                    description: Revenue attributed to template (INR)
                    example: 125000.00
        summary:
          type: object
          description: Aggregated metrics across all templates
          properties:
            total_templates:
              type: integer
              minimum: 0
              description: Number of templates in report
              example: 15
            total_sent:
              type: integer
              minimum: 0
              description: Total messages sent across all templates
              example: 18750
            avg_delivery_rate:
              type: number
              format: double
              minimum: 0
              maximum: 1
              description: Average delivery rate
              example: 0.985
            avg_open_rate:
              type: number
              format: double
              minimum: 0
              maximum: 1
              description: Average open rate
              example: 0.715
            avg_click_rate:
              type: number
              format: double
              minimum: 0
              maximum: 1
              description: Average click rate
              example: 0.245
            total_revenue:
              type: number
              format: double
              minimum: 0
              description: Total attributed revenue (INR)
              example: 1875000.00

    ErrorResponse:
      type: object
      required: [type, title, status]
      properties:
        type:
          type: string
          format: uri
          description: URI identifying the problem type
          example: "https://our_website_link.com/errors/validation"
        title:
          type: string
          description: Short, human-readable summary
          example: "Template Validation Error"
        status:
          type: integer
          description: HTTP status code
          example: 400
        detail:
          type: string
          description: Human-readable explanation
          example: "Template content contains invalid MJML syntax"
        instance:
          type: string
          format: uri
          description: URI reference identifying the specific occurrence
          example: "/templates/order_confirmation_premium_v2"
        errors:
          type: array
          description: Field-level validation errors
          items:
            type: object
            properties:
              field:
                type: string
                example: "content"
              message:
                type: string
                example: "MJML syntax error at line 15: unclosed mj-text tag"
              code:
                type: string
                example: "INVALID_MJML_SYNTAX"

